<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script>
        var trainStation = [
            {idStation: "9432185", name: "Santarém"}, 
            {idStation: "9431039", name: "Lisboa - Oriente"}, 
            {idStation: "9431005", name: "Braço de Prata"}, 
        ]

        function createAndAppend(parent, type, append)
        {
            var nameCell = document.createElement(type);
            nameCell.textContent = append;
            parent.appendChild(nameCell);
        }

        function generateTable(data)
        {
            var tableBody = document.querySelector("#myTable tbody");

            data.forEach(
                item => 
                {
                    var row = document.createElement("tr");
                    createAndAppend(row, "td", item.TipoServico);
                    createAndAppend(row, "td", item.DataHoraPartidaChegada);
                    createAndAppend(row, "td", item.NomeEstacaoOrigem);
                    createAndAppend(row, "td", item.NomeEstacaoDestino);
                    createAndAppend(row, "td", item.Observacoes);
                    tableBody.appendChild(row);
                }
            );
        }

        function getJsonRequest(url) {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);

            xhr.onreadystatechange =
                () => 
                {
                    if (xhr.readyState === 4 && xhr.status === 200) {
                        var response = JSON.parse(xhr.responseText);
                        var trains  = response.response[0].NodesComboioTabelsPartidasChegadas;
                        generateTable(trains)                        
                    }
                };
            xhr.send();
        }

        function updateSelector()
        {
            var selectElement = document.querySelector("#mySelect");
            trainStation.forEach(
                item => 
                {
                    var option = document.createElement("option");
                    option.value = item.idStation;
                    option.textContent = item.name;
                    selectElement.appendChild(option);
                }
            );
        }
        
        function getSelectedValue() {
            var selectElement = document.querySelector("#mySelect");
            return selectElement.value;
        }

        function clearTable() {
            var tableBody = document.querySelector("#myTable tbody");
            tableBody.innerHTML = "";
        }
        
        function updateTable()
        {
            clearTable()
            var stationId = getSelectedValue();
            var datepickerBegin = document.getElementById("datepickerBegin").value;
            var hourBegin = document.getElementById("hourBegin").value;
            var datepickerEnd = document.getElementById("datepickerEnd").value;
            var hourEnd = document.getElementById("hourEnd").value;

            var services = getSelectedCheckboxes();
            
            getJsonRequest("https://www.infraestruturasdeportugal.pt/negocios-e-servicos/partidas-chegadas/" 
                + stationId + "/" 
                + datepickerBegin + "%20"
                + hourBegin + "/"
                + datepickerEnd + "%20"
                + hourEnd + "/"
                + services);
        }

        function updateInputData()
        {
            var currentDate = new Date();
            var year = currentDate.getFullYear();
            var month = String(currentDate.getMonth() + 1).padStart(2, "0");
            var day = String(currentDate.getDate()).padStart(2, "0");
            var formattedDate = year + "-" + month + "-" + day;
            document.getElementById("datepickerBegin").value = formattedDate;
            document.getElementById("hourBegin").value = "07:00";
            document.getElementById("datepickerEnd").value = formattedDate;
            document.getElementById("hourEnd").value = "23:59";
        }

        function populateCheckboxes()
        {
            var data = [
                { value: "ALFA", label: "Alfa" },
                { value: "IC", label: "InterCidades" },
                { value: "IR", label: "InterRegional" },
                { value: "REGIONAL", label: "Regional" },
                { value: "URB%7CSUBUR", label: "SubUrbano" },
            ];

            var checkboxContainer = document.getElementById("checkboxContainer");

            data.forEach(function (item) {
                var checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.name = "options"; // Set a common name for all checkboxes
                checkbox.value = item.value;
                checkbox.id = item.value;
                checkbox.checked = true;

                var label = document.createElement("label");
                label.setAttribute("for", item.value);
                label.textContent = item.label;

                checkboxContainer.appendChild(checkbox);
                checkboxContainer.appendChild(label);
                checkboxContainer.appendChild(document.createElement("br"));
            });
        }
        function getSelectedCheckboxes() {
            var checkboxes = document.querySelectorAll("#checkboxContainer input[type='checkbox']");
            var selectedValues = "";

            checkboxes.forEach(
                checkbox => 
                {
                    if (checkbox.checked) 
                    {
                        selectedValues += checkbox.value + ",%20";
                    }
                }
            );
            return selectedValues.substring(0, selectedValues.length - 4);
        }
    </script>
    <title>Portugal Trains Schedule</title>
</head>

<body>
    <p>Estação: <select id="mySelect"></select></p>
    <p>Início: <input type="date" id="datepickerBegin"><input type="text" id="hourBegin"></p>
    <p>Fim: <input type="date" id="datepickerEnd"><input type="text" id="hourEnd"></p>

    <div id="checkboxContainer">
        <!-- The checkboxes will be appended here -->
    </div>
    
    <button onclick="updateTable()">Get</button>

    <table id="myTable">
        <thead>
          <tr>
            <th>Serviço</th>
            <th>Partida</th>
            <th>Origem</th>
            <th>Destino</th>
            <th>Observações</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>

      <script>
        updateSelector();
        updateInputData();
        populateCheckboxes();
      </script>
</body>

</html>